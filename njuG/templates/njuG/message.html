{% extends "njuG/home_base.html" %}

{% load staticfiles %}
{% load filters %}

{% block loadCss %}
<link rel="stylesheet" type="text/css" href="{% static "css/index.css" %}">
<link rel="stylesheet" type="text/css" href="{% static "css/home.css" %}">
<link rel="stylesheet" type="text/css" href="{% static "css/message.css" %}">
{% endblock %}

{% block tab_menu %}
<div class="ui vertical fluid tabular menu">

    <a href="{% url 'myHome' %}" class="item">
      我的发布
    </a>
    <a href="{% url 'message' %}" class="item active">
      我的消息
      {% if request.user.profile.unreadMessageCount > 0 %}
      <div class="ui teal pointing left label messageCount">{{request.user.profile.unreadMessageCount}}</div>
      {% endif %}
    </a>

</div>
{% endblock %}

{% block tab_content %}

<div class="ui feed">
    {% for message in messages %}
    {% with source=message.source %}
    <div class="event">
        <div class="label">
            {% if source.profile.hasAvatar %}
            <img src="{% static message.source.username|getAvatarPath %}">
            {% else %}
            <img src="{% static ''|getAvatarPath %}">
            {% endif %}
        </div>
        <div class="content">
            <div class="summary">
                <a>{{ source.username }}</a>
                <span class="messageTopic">
                    {% if message|isPostComment or message|isReplyPostComment %}
                    &nbsp在$nbsp{{ message.masterPost.content }}
                    {% elif message|isBlogComment or message|isReplyBlogComment %}
                    &nbsp在&nbsp{{ message.masterBlog.title }}
                    {% endif %}
                </span>
                {% if message|isPrivateMessage %}
                向你发送私信
                {% else %}
                中评论你：
                {% endif %}
                <div class="date">
                    {{ message.time }}
                </div>
            </div>
            <div class="extra text">
                {{ message.content }}
            </div>
            
            
            <div class="ui comments">
                <div class="comment">
                    <div class="actions">
                        <a class="reply postCommentReply" messageid="{{message.id}}">回复</a>
                        <a class="read" messageid="{{message.id}}">已读</a>
                        {% if message|isPostComment or message|isReplyPostComment %} 
                        <form class="ui form postCommentReplyForm" style="display: none" 
                        commentid="{{ message.postComment.id}}", postid="{{ message.masterPost.id}}">
                        
                        {% elif message|isBlogComment %}
                        <form class="ui form replyCommentForm" style="display: none" 
                        commentid="{{ message.blogComment.id}}", masterCommentid="{{message.blogComment.id}}"
                         blogid="{{ message.masterBlog.id}}">
                        
                        {% elif message|isReplyBlogComment %}
                        <form class="ui form replyCommentForm" style="display: none" 
                        commentid="{{ message.blogComment.id}}", masterCommentid="{{message.masterComment.id}}"
                         blogid="{{ message.masterBlog.id}}">
                        
                        {% elif message|isPrivateMessage %}
                        <form class="ui form replyMessageForm" style="display: none"
                        targetid="{{message.source.id}}" >
                        {% endif %}
                            <div class="field">
                                <textarea rows="2" name="content" required></textarea>
                            </div>
                            <button class="ui labeled icon tiny basic button" type="submit">
                                <i class="send icon"></i>
                                回复
                            </button>
                        </form>
                    </div>                
                </div>
            </div>

            
        </div>
    </div>
    {% endwith %}
    {% endfor %}
</div>

<script>
    $(document).ready(function(){
        $(".actions").children("a").click(function(){
            var messageid = $(this).attr("messageid");
            $.ajax({
                url: "/njuG/setMessageRead/",
                dataType: "json",
                headers: { "X-CSRFToken": $.cookie("csrftoken") },
                type: 'POST',
                data: {"messageid": messageid},
                success: function(response){
                    if(response['result']==1){
                        var messageCount = $(".messageCount").first().text();
                        messageCount = parseInt(messageCount);
                        messageCount -= 1;
                        $(".messageCount").text(messageCount);
                        if(messageCount==0){
                            $(".messageCount").remove();
                        }
                    }
                },
            });
        });
    });
</script>
{% endblock %}

{% block loadJs %}
<script src="{% static "js/createEvent.js" %}"></script>
<script src="{% static "js/replyBlogComment.js" %}"></script>
<script src="{% static "js/replyMessage.js" %}"></script>
{% endblock%}
